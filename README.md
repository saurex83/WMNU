Мысли:

Блочная пересылка данных.
Для пересылки большого обьема от ТД к узлу нужно контролировать результат передачи.Подтверждать каждый отправленный пакет накладно, сильно уменьшит пропускную способность сети. для блочный пересылок используется служба порт номер 6. 
Она работает поверх WP. Данные от ТД следут блоками по 256 байт. каждый блок разбит на пакеты по 64 байта. пакет содержит информацию о номере в блоке, общем количестве пакетов, идентификатор блока. Служба после начала принятия блока ждет поступление всех пактов блока.
по таймауту отправляет сообщение ТД о принятых или пропущенных блоках. ТД повторяет отправку.
В один момент времени ТД отсылкает данные только однлиу устройству, у ТД может не хватать памяти.
Все блоки узлом сохраняются в spi flash. служба используется для обновления прошивки. 
crc проверять не стоит, так как это выполняется при приеме пакета.
Принятые данные в памяти сохранять в зашифрованном виде с помощью простенького алгоритма.
перед прошивкой программы проверить корректность программы.
 
Подключение узла к сети и адреса узлов.
применениее 8 байтных адресов крайне расточительно для памяти и занимают большую часть пакет данных.
Можно использовать двух байтные адреса. 
Для этого должна быть служба подключения на каждом узле.распределением адресов занимается ТД.
Узел ищет своих соседей, выбирает с наименьшим ETX. Передает запрос подключения на порт 5 одноадресным пакетом.
Запрос содержит mac адрес узла. Промежуточный узел делает запрос к ТД. ТД возвращает ответ. Промежуточный узел формирует ШВС ответ, который содержит короткий присвоенный адрес.
Узел, желающий подключится, принимает швс и применяет настройки. 
Узел при запросе подключени заполняе поля: Node_dst = адрес соседа. node_src = ff, wp.dst = адрес соседа, wp.src = ff, wp.port = 0 в нагрузку добавляет свой мак.
Узел ждет wp швс по порту 5 содержащий ответ подтверждения или запрета.
Служба на порту 5 занимается приемом запросов подключения, выдачей подтверждения, передачей запросов ТД, приемом ответов ТД.

Сделать карту примеров взаимодействий в сети.

Логический адрес dst,src 00 зарегестрирован для ТД.
Логический адрес dst FF зарегестрирован как ШВС.
Логический адрес src FF зарегестрирован как узел без адреса.

Логика маршрутизации.
WP.DST = 0, WP.SRC != 0, WP.SRC != FF то передаем соседу с наименьшим ETX.
WP.DST != 0, wp.src проверка корректности, то пользуемся таблицей маршрутизации.
Логика встроена в протокол маршрутизации. протокол маршрутизации самостоятельно создает таблицы.



Список разрешенных узлов для подключения ТД может хранить во внешней spi flash.

Начальный поиск сети это вообще отдельный модуль, который запускаеться netif.
модуль напрямую работает с радио.

Протокол синхронизации работет в режиме слэв и мастер. настройку получает из netif.

добавить стандартные приложения для мониторинга состояния узла и сбора статистики, а также удаленное управление. Передаваемые данные стандартищовать.
в режиме точки доступа приложения собирают данные но не передают.

в режиме точки доступа использовать динамические данные с уничтожением после чтения в уарт.
после приема данных от узла, структура с принятой информацией и метаданными.
после чтения по уарт, она уничтожается.

узел при старте можно завести в командный режим по отладочному уарт. запустить тесты оборудования, передачу и прием данных.
так же сменить ключ сети.

протокол маршрутизации. если у получателя открыто нескольк входящих окон,
выбираем окно случайным образом.

ядро рандома иницилизируем белым шумом.
делает это радио при иницилизации.

точка доступа. командный процессор уарт работает в режиме запрос-ответ.
прием данных в кольцевой буфер дма и прерывание по /n
